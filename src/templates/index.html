{% extends "layout.html" %}

{% block title %}
Reference app
{% endblock %}

{% block body %}

<h2>Lohtu for Outi, App made with Love</h2>

<form method="get" action="/" style="margin-bottom: 1em;" class="search wrapper">
  <input type="text" name="q" placeholder="Search" value="{{ q|default('') }}" class="search_input">
  <button type="submit" class="search_button"><i class="fa fa-search"></i></button>
  <a href="/">Clear</a>
</form>

{% if q %}
  <p>Results</p>
{% endif %}

</ul>
<p>
  <label for="reference_type" class="ref_type">Reference type:</label><br />
  <select name="reference_type" id="reference_type" class="ref_selection" required>
    <option value="">choose</option>
    <option value="article">@article</option>
    <option value="book">@book</option>
    <option value="booklet">@booklet</option>
    <option value="conference">@conference</option>
    <option value="inbook">@inbook</option>
    <option value="incollection">@incollection</option>
    <option value="inproceedings">@inproceedings</option>
    <option value="manual">@manual</option>
    <option value="mastersthesis">@mastersthesis</option>
    <option value="phdthesis">@phdthesis</option>
    <option value="proceedings">@proceedings</option>
    <option value="techreport">@techreport</option>
    <option value="unpublished">@unpublished</option>
  </select>
</p>
<form action="/new_reference" method="get" onsubmit="return validateReferenceType()" class="create_new_ref">
  <input type="hidden" name="reference_type" id="selected_reference_type">
  <button type="submit" class="add_button">Create new reference</button>
</form>

<div class="layout">
  <ul>
    {% for reference in references %}
      <script>
          function showConfirmation(event) {
              event.preventDefault();

              if (confirm("Confrim deletion of reference")) {
                  event.target.submit();}
              }
      </script>
      <li style="display: flex">
        <div class="frontpage-references" style="cursor: pointer;" onclick="showBibtex(`{{ reference.to_bibtex() }}`)">
          <div><strong>@{{ reference.ref_type }}</strong></div>
          {% if reference.required_fields %}
            {% for field in reference.required_fields %}
              {% set val = reference[field] %}
              {% if val %}
                <div>{{ field|replace('_',' ')|title }}: {{ val }}</div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div>No required fields</div>
          {% endif %}
          <div class="actions">
            <form action="/edit_reference" method="get">
              <input type="hidden" name="reference_id" value="{{ reference.id }}">
              <button type="submit">Edit</button>
            </form>
            <form action="/delete_ref" method="post" onsubmit="showConfirmation(event)">
              <input type="hidden" name="reference_id" value="{{ reference.id }}">
              <button type="submit">Delete</button>
            </form>
            <button class="btn btn-primary" onClick="copyToClipboard(`{{ reference.to_bibtex() }}`); event.stopPropagation();">Copy bibtex</button>
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>

  <div id="detail-pane" class="detail-pane">
    <em>Click a reference to show its BibTeX here.</em>
  </div>
</div>

<form action="/export" method="get">
  <button type="submit">Export all to bibtex</button>
</form>

<script>
  function validateReferenceType() {
    const select = document.getElementById('reference_type');
    const selectedValue = select.value;
    
    if (!selectedValue) {
      alert('Please select a reference type before creating a new reference.');
      return false;
    }
    
    document.getElementById('selected_reference_type').value = selectedValue;
    return true;
  }

  function copyToClipboard(bibtex) {
    navigator.clipboard.writeText(bibtex)
  }

  function showBibtex(bibtex) {
    const pane = document.getElementById('detail-pane');
    if (!pane) return;
    pane.textContent = bibtex;
  }
</script>

{% endblock %}