{% extends "layout.html" %}

{% block title %}
Reference app
{% endblock %}

{% block body %}

<h1>Lohtu for Outi, App made with Love</h1>

<form method="get" action="/" style="margin-bottom: 1em;" class="search wrapper">
  <input type="text" name="q" placeholder="Search" value="{{ q|default('') }}" class="search_input">
  <button type="submit" class="search_button"><i class="fa fa-search"></i></button>
  <a href="/">Clear</a>
</form>

{% if q %}
  <p>Results</p>
{% endif %}

<div class="create_reference_section">
  <div>
    <p>Enter a DOI to automatically create a reference with pre-filled fields:</p>
    <form action="/lookup_doi" method="post">
      <input type="text" name="doi" id="doi_lookup" placeholder="e.g., 10.1145/3366423.3380203">
      <button type="submit">Import from DOI</button>
    </form>
  </div>

  <div style="font-size: 1.2em; font-weight: bold; color: rgb(81, 81, 81); padding: 0 40px; flex-shrink: 0;">OR</div>

  <div>
    <div style="margin-bottom: 5px;">Choose a type and click the button to create a reference manually:</div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <select name="reference_type" id="reference_type" class="ref_selection" required>
        <option value="">choose type</option>
        <option value="article">@article</option>
        <option value="book">@book</option>
        <option value="booklet">@booklet</option>
        <option value="conference">@conference</option>
        <option value="inbook">@inbook</option>
        <option value="incollection">@incollection</option>
        <option value="inproceedings">@inproceedings</option>
        <option value="manual">@manual</option>
        <option value="mastersthesis">@mastersthesis</option>
        <option value="phdthesis">@phdthesis</option>
        <option value="proceedings">@proceedings</option>
        <option value="techreport">@techreport</option>
        <option value="unpublished">@unpublished</option>
      </select>
      <form action="/new_reference" method="get" onsubmit="return validateReferenceType()" class="create_new_ref" style="margin: 0;">
        <input type="hidden" name="reference_type" id="selected_reference_type">
        <button type="submit" class="add_button">Create new reference</button>
      </form>
    </div>
  </div>
</div>

<div class="layout">
  <ul>
    {% for reference in references %}
      <script>
          function showConfirmation(event) {
              event.preventDefault();

              if (confirm("Confrim deletion of reference")) {
                  event.target.submit();}
              }
      </script>
      <li style="display: flex">
        <div class="frontpage-references" style="cursor: pointer;" onclick="showBibtex(`{{ reference.to_bibtex() }}`)">
          <div class="actions">
            <form action="/edit_reference" method="get">
              <input type="hidden" name="reference_id" value="{{ reference.id }}">
              <button type="submit">Edit</button>
            </form>
            <form action="/delete_ref" method="post" onsubmit="showConfirmation(event)">
              <input type="hidden" name="reference_id" value="{{ reference.id }}">
              <button type="submit">Delete</button>
            </form>
            <button class="btn btn-primary" onClick="copyToClipboard(`{{ reference.to_bibtex() }}`); event.stopPropagation();">Copy bibtex</button>

            <input type="checkbox" name="reference_id" value="{{ reference.id }}" form="export_selected_form">
          </div>
          <div><strong>@{{ reference.ref_type }}</strong></div>
          {% if reference.required_fields %}
            {% for field in reference.required_fields %}
              {% set val = reference[field] %}
              {% if val %}
                <div>{{ field|replace('_',' ')|title }}: {{ val }}</div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div>No required fields</div>
          {% endif %}
        </div>
      </li>
    {% endfor %}
  </ul>

  <div id="detail-pane" class="detail-pane">
    <em>Click a reference to show its BibTeX here.</em>
  </div>
</div>

<div class='parent'>
  <div class='child inline-block-child'>
    <form action="/export" method="get">
      <button type="submit">Export all to bibtex</button>
    </form></div>
    <div class='child inline-block-child'>  <form id="export_selected_form" action="/export_selected" method="get" onsubmit="return selectedReferences(event)">
      <button type="submit">Export selected to bibtex</button>
    </form>
</div>

<script>
  function validateReferenceType() {
    const select = document.getElementById('reference_type');
    const selectedValue = select.value;

    if (!selectedValue) {
      alert('Please select a reference type before creating a new reference.');
      return false;
    }

    document.getElementById('selected_reference_type').value = selectedValue;
    return true;
  }

  function copyToClipboard(bibtex) {
    navigator.clipboard.writeText(bibtex)
  }

  function showBibtex(bibtex) {
    const pane = document.getElementById('detail-pane');
    if (!pane) return;
    pane.textContent = bibtex;
  }

  function selectedReferences(event) {
    const checked = document.querySelectorAll('input[name="reference_id"]:checked');
    if (checked.length === 0) {
      alert('Please select at least one reference to export.');
      event.preventDefault();
      return false;
    }
    return true;
  }
</script>

{% endblock %}