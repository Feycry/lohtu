{% extends "layout.html" %}

{% block title %}
Reference app
{% endblock %}

{% block body %}

<h2>Lohtu for Outi, App made with Love</h2>

<form method="get" action="/" style="margin-bottom: 1em;" class="search">
  <input type="text" name="q" placeholder="Search" value="{{ q|default('') }}">
  <button type="submit">Search</button>
  <a href="/">Clear</a>
</form>

{% if q %}
  <p>Results</p>
{% endif %}

</ul>
<p>
  <label for="reference_type">Reference type:</label><br />
  <select name="reference_type" id="reference_type" required>
    <option value="">(choose)</option>
    <option value="article">@article</option>
    <option value="book">@book</option>
    <option value="booklet">@booklet</option>
    <option value="conference">@conference</option>
    <option value="inbook">@inbook</option>
    <option value="incollection">@incollection</option>
    <option value="inproceedings">@inproceedings</option>
    <option value="manual">@manual</option>
    <option value="mastersthesis">@mastersthesis</option>
    <option value="phdthesis">@phdthesis</option>
    <option value="proceedings">@proceedings</option>
    <option value="techreport">@techreport</option>
    <option value="unpublished">@unpublished</option>
  </select>
</p>
<form action="/new_reference" method="get" onsubmit="return validateReferenceType()">
  <input type="hidden" name="reference_type" id="selected_reference_type">
  <button type="submit" class="add_button">Create new reference</button>
</form>

<ul>
  {% for reference in references %}
    <script>
        function showConfirmation(event) {
            event.preventDefault();

            if (confirm("Confrim deletion of reference")) {
                event.target.submit();}
            }
    </script>
    <li style="display: flex">
      <div>
        {{ reference }} 
        <form action="/delete_ref" method="post" onsubmit="showConfirmation(event)" >
          <input type="hidden" name="reference_id" value="{{ reference.id }}">
          <button type="submit">Delete reference</button>
        </form>
        <form action="/edit_reference" method="get">
          <input type="hidden" name="reference_id" value="{{ reference.id }}">
          <button type="submit">Edit reference</button>
        </form>
        <button class="btn btn-primary" onClick="copyToClipboard(`{{ reference.to_bibtex() }}`)">Copy bibtex to clipboard</button>
      </div>
    </li>
  {% endfor %}

<form action="/export" method="get">
  <button type="submit">Export all to bibtex</button>
</form>

<script>
  function validateReferenceType() {
    const select = document.getElementById('reference_type');
    const selectedValue = select.value;
    
    if (!selectedValue) {
      alert('Please select a reference type before creating a new reference.');
      return false;
    }
    
    document.getElementById('selected_reference_type').value = selectedValue;
    return true;
  }

  function copyToClipboard(bibtex) {
    navigator.clipboard.writeText(bibtex)
  }
</script>

{% endblock %}